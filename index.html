<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signal Blocks — BTCUSDT Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind (v3) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-[13px] leading-5">
<div class="max-w-6xl mx-auto p-4 space-y-10">

  <h1 class="text-2xl font-bold">📊 Signal Blocks — BTCUSDT (Binance, key-free)</h1>

  <!-- █████ Block A █████ -->
  <section>
    <h2 class="text-xl font-semibold">🟦 Block A – Price · Volatility · Trend</h2>
    <div id="cardsA" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 mt-2"></div>
  </section>

  <!-- █████ Block B █████ -->
  <section>
    <h2 class="text-xl font-semibold">🟨 Block B – Derivatives Positioning</h2>
    <table id="tblB" class="w-full text-left bg-white rounded shadow mt-2">
      <thead class="bg-slate-100">
        <tr><th class="p-1 w-52">Metric</th><th class="p-1">Value</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <!-- █████ Block C █████ -->
  <section>
    <h2 class="text-xl font-semibold">🟥 Block C – Liquidations (last 4 h, USD millions)</h2>
    <table id="tblC" class="w-full text-left bg-white rounded shadow mt-2">
      <thead class="bg-slate-100">
        <tr><th class="p-1 w-24">Bucket</th><th class="p-1">Long $</th><th class="p-1">Short $</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <!-- █████ Block D █████ -->
  <section>
    <h2 class="text-xl font-semibold">🟪 Block D – Sentiment · Community</h2>
    <table id="tblD" class="w-full text-left bg-white rounded shadow mt-2">
      <thead class="bg-slate-100">
        <tr><th class="p-1 w-52">Metric</th><th class="p-1">Value</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <p id="status" class="text-gray-500"></p>
</div>

<script>
/* ═════════ 0 · CONFIG ═════════ */
const SYMBOL='BTCUSDT';
const TF_MAP={'15 m':'15m','1 h':'1h','4 h':'4h','1 d':'1d'};
const LIMIT_CAND = 250;
const POLL_A = 60_000,  POLL_B = 60_000,  POLL_C = 60_000,  POLL_D = 300_000;
const CG_ID = 'bitcoin';
const CORS = u => `https://cors.isomorphic-git.org/${encodeURIComponent(u)}`;

/* ═════════ 1 · Build Block A cards ═════════ */
const wrapA = document.getElementById('cardsA');
for (const tf in TF_MAP){
  wrapA.insertAdjacentHTML('beforeend',`
    <div class="bg-white rounded shadow p-3 space-y-1">
      <h3 class="font-medium mb-1">${tf}</h3>
      <div>EMA-50        <span id="${tf}-ema50">…</span></div>
      <div>EMA-200       <span id="${tf}-ema200">…</span></div>
      <div>RSI-14        <span id="${tf}-rsi">…</span></div>
      <div>BB width %   <span id="${tf}-bb">…</span></div>
      <div>ATR/Close %  <span id="${tf}-atr">…</span></div>
    </div>`);}

/* ═════════ 2 · Math helpers ═════════ */
const sma=(a,p)=>a.slice(-p).reduce((s,x)=>s+x,0)/p;
const std=(a,p)=>{const s=a.slice(-p),m=sma(s,p);
  return Math.sqrt(s.reduce((t,x)=>t+(x-m)**2,0)/p);};
const ema=(a,p)=>{if(a.length<p)return null;const k=2/(p+1);
  let e=sma(a.slice(0,p),p);for(let i=p;i<a.length;i++)e=a[i]*k+e*(1-k);return e;};
const rsi=(a,p)=>{if(a.length<p+1)return null;let g=0,l=0;
  for(let i=1;i<=p;i++){const d=a[i]-a[i-1];d>=0?g+=d:l-=d;}
  let ag=g/p,al=l/p;for(let i=p+1;i<a.length;i++){const d=a[i]-a[i-1];
    ag=(ag*(p-1)+(d>0?d:0))/p;al=(al*(p-1)+(d<0?-d:0))/p;}
  return al===0?100:100-100/(1+ag/al);};
const atr=(h,l,c,p)=>{if(h.length<p+1)return null;const tr=[];
  for(let i=1;i<h.length;i++)
    tr.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));
  return sma(tr.slice(-p),p);};
const fmt=(v,p=2)=>v==null?'⚠️':(+v).toFixed(p);
const zScore=a=>{const m=sma(a,a.length),s=std(a,a.length);return s?(a.at(-1)-m)/s:0;};

/* ═════════ 3 · Block A polling ═════════ */
async function pollA(){
  for(const [lbl,tf] of Object.entries(TF_MAP)){
    try{
      const rows=await fetch(`https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${tf}&limit=${LIMIT_CAND}`).then(r=>r.json());
      const c=rows.map(r=>+r[4]),h=rows.map(r=>+r[2]),l=rows.map(r=>+r[3]),last=c.at(-1);
      const out=[['ema50',ema(c,50)],['ema200',ema(c,200)],['rsi',rsi(c,14)],
                 ['bb', std(c,20)?((4*std(c,20)/last)*100).toFixed(2):null],
                 ['atr',atr(h,l,c,14)?((atr(h,l,c,14)/last)*100).toFixed(2):null]];
      out.forEach(([k,v])=>document.getElementById(`${lbl}-${k}`).textContent=
                   fmt(v,k==='rsi'?1:2));
    }catch(e){console.error('A',lbl,e);}
  }
}
pollA(); setInterval(pollA,POLL_A);

/* ═════════ 4 · Block B polling ═════════ */
function setRow(tbl,k,v,cls=''){
  let tr=tbl.querySelector(`tr[data-k="${k}"]`);
  if(!tr){tr=document.createElement('tr');tr.dataset.k=k;
    tr.innerHTML=`<td class="p-1">${k}</td><td class="p-1" data-v></td>`;
    tbl.appendChild(tr);}
  const td=tr.querySelector('[data-v]');td.textContent=v;td.className=`p-1 ${cls}`;
}
async function pollB(){
  try{
    const fund=await fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${SYMBOL}&limit=1000`).then(r=>r.json());
    const z=zScore(fund.slice(-42).map(d=>+d.fundingRate)).toFixed(2);
    setRow(document.querySelector('#tblB tbody'),'Funding z-score',z,
           Math.abs(z)>=2?(z>0?'text-rose-600':'text-emerald-600'):'');
    const [oiNow,oiHist]=await Promise.all([
      fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${SYMBOL}`).then(r=>r.json()),
      fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${SYMBOL}&period=1h&limit=24`).then(r=>r.json())
    ]);
    const pct=((+oiNow.openInterest-+oiHist[0].sumOpenInterest)/+oiHist[0].sumOpenInterest*100).toFixed(1);
    setRow(document.querySelector('#tblB tbody'),'OI %Δ (24 h)',pct+' %',pct>0?'text-emerald-600':'text-rose-600');
  }catch(e){console.error('B',e);}
}
pollB(); setInterval(pollB,POLL_B);

/* ═════════ 5 · Block C – live liquidation buckets ═════════ */
const BUCKET_MS=60*60*1000, MAXB=4, buckets=[];
function curBucket(){
  const t=Math.floor(Date.now()/BUCKET_MS)*BUCKET_MS;
  let b=buckets.find(x=>x.t===t);
  if(!b){b={t,long:0,short:0};buckets.push(b);if(buckets.length>MAXB)buckets.shift();}
  return b;
}
function renderC(){
  const tb=document.querySelector('#tblC tbody');tb.innerHTML='';
  buckets.slice().reverse().forEach((b,i)=>tb.insertAdjacentHTML('beforeend',`
    <tr><td class="p-1">${i===0?'0-1 h':`${i}-${i+1} h`}</td>
        <td class="p-1 text-rose-600">${(b.long/1e6).toFixed(1)} M</td>
        <td class="p-1 text-emerald-600">${(b.short/1e6).toFixed(1)} M</td></tr>`));
}
new WebSocket('wss://fstream.binance.com/ws/!forceOrder@arr').onmessage=e=>{
  JSON.parse(e.data).forEach(d=>{
    if(d.S!==SYMBOL)return;const v=+d.p*+d.q;d.s==='SELL'?curBucket().long+=v:curBucket().short+=v;
  });
};
renderC(); setInterval(renderC,POLL_C);

/* ═════════ 6 · Block D – CoinGecko + Pushshift with guard ═════════ */
async function pollD(){
  try{
    const cg=await fetch(`https://api.coingecko.com/api/v3/coins/${CG_ID}`).then(r=>r.json());
    /* safe Pushshift call */
    let red='⚠️';
    try{
      const end=Math.floor(Date.now()/1000),start=end-172800;
      const url=CORS(`https://api.pushshift.io/reddit/search/submission/`+
                     `?q=${CG_ID}&after=${start}&before=${end}&size=0&metadata=true`);
      const j=await fetch(url).then(r=>r.json());
      red=j.metadata.total_results??'⚠️';
    }catch{/* ignore Pushshift error */}
    const tb=document.querySelector('#tblD tbody');
    setRow(tb,'Sentiment votes %',cg.sentiment_votes_up_percentage.toFixed(1));
    setRow(tb,'Community score',  cg.community_score.toFixed(1));
    setRow(tb,'Reddit posts 48 h',String(red));
  }catch(e){console.error('D',e);}
}
pollD(); setInterval(pollD,POLL_D);

/* ═════════ status clock ═════════ */
setInterval(()=>document.getElementById('status').textContent=
  'Last refresh '+new Date().toLocaleTimeString(),1000);
</script>
</body>
</html>
