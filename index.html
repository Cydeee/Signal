<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Signal Blocks â€” BTCUSDT Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-[13px] leading-5">
<div class="max-w-6xl mx-auto p-4 space-y-10">
  <h1 class="text-2xl font-bold">ğŸ“Š Signal Blocks â€” BTCUSDT (key-free)</h1>

  <!-- A -->
  <section>
    <h2 class="text-xl font-semibold">ğŸŸ¦ Block A Â· Price / Volatility / Trend</h2>
    <div id="cardsA" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 mt-2"></div>
  </section>

  <!-- B -->
  <section>
    <h2 class="text-xl font-semibold">ğŸŸ¨ Block B Â· Derivatives Positioning</h2>
    <table id="tblB" class="w-full text-left bg-white rounded shadow mt-2">
      <thead class="bg-slate-100">
        <tr><th class="p-1 w-52">Metric</th><th class="p-1">Value</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- C (removed) -->
  <section>
    <h2 class="text-xl font-semibold">ğŸŸ¥ Block C Â· Liquidations</h2>
    <div class="bg-white rounded shadow p-3 mt-2 text-gray-600 italic">
      [Work in progress]
    </div>
  </section>

  <!-- D -->
  <section>
    <h2 class="text-xl font-semibold">ğŸŸª Block D Â· Sentiment</h2>
    <table id="tblD" class="w-full text-left bg-white rounded shadow mt-2">
      <thead class="bg-slate-100">
        <tr><th class="p-1 w-56">Metric</th><th class="p-1">Value</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- E -->
  <section>
    <h2 class="text-xl font-semibold">ğŸŸ« Block E Â· Macro Risk Context</h2>
    <table id="tblE" class="w-full text-left bg-white rounded shadow mt-2">
      <thead class="bg-slate-100">
        <tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <p id="status" class="text-gray-500"></p>
</div>

<script>
/* â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SYMBOL = 'BTCUSDT';
const CG_ID   = 'bitcoin';
const LIMIT   = 250;
const TF      = { '15m':'15 m', '1h':'1 h', '4h':'4 h', '1d':'1 d' };
const CADENCE = { A:60000, B:60000, D:300000, E:300000 };

/* â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const byId = id => document.getElementById(id);
const fmt  = (x,p=2) => x==null ? 'âš ï¸' : (+x).toFixed(p);
function setCell(tbl,key,val){
  let tr = tbl.querySelector(`tr[data-k="${key}"]`);
  if(!tr){
    tr = document.createElement('tr');
    tr.dataset.k = key;
    tr.innerHTML = `<td class="p-1">${key}</td><td class="p-1" data-v></td>`;
    tbl.querySelector('tbody').appendChild(tr);
  }
  tr.querySelector('[data-v]').textContent = val;
}
function row(tbl,k,v,cls=''){
  let tr = tbl.querySelector(`tr[data-k="${k}"]`);
  if(!tr){
    tr=document.createElement('tr');
    tr.dataset.k=k;
    tr.innerHTML=`<td class="p-1">${k}</td><td class="p-1" data-v></td>`;
    tbl.querySelector('tbody').appendChild(tr);
  }
  const td=tr.querySelector('[data-v]');
  td.textContent=v;
  td.className=`p-1 ${cls}`;
}

/* â”€â”€â”€ BLOCK A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// build cards
const wrapA = byId('cardsA');
for(const intv in TF){
  wrapA.insertAdjacentHTML('beforeend',`
    <div class="bg-white rounded shadow p-3 space-y-1">
      <h3 class="font-medium">${TF[intv]}</h3>
      <div>EMA-50       <span id="${intv}-ema50">â€¦</span></div>
      <div>EMA-200      <span id="${intv}-ema200">â€¦</span></div>
      <div>RSI-14       <span id="${intv}-rsi">â€¦</span></div>
      <div>BB width %   <span id="${intv}-bb">â€¦</span></div>
      <div>ATR/Close %  <span id="${intv}-atr">â€¦</span></div>
    </div>`);
}
// math
const sma=(a,p)=>a.slice(-p).reduce((s,x)=>s+x,0)/p;
const std=(a,p)=>{const s=a.slice(-p),m=sma(s,p);return Math.sqrt(s.reduce((t,x)=>t+(x-m)**2,0)/p);};
const ema=(a,p)=>{if(a.length<p)return null;const k=2/(p+1);let e=sma(a.slice(0,p),p);
  for(let i=p;i<a.length;i++)e=a[i]*k+e*(1-k);return e;};
const rsi=(a,p)=>{if(a.length<p+1)return null;let g=0,l=0;
  for(let i=1;i<=p;i++){const d=a[i]-a[i-1];d>=0?g+=d:l-=d;}
  let ag=g/p,al=l/p;
  for(let i=p+1;i<a.length;i++){const d=a[i]-a[i-1];
    ag=(ag*(p-1)+(d>0?d:0))/p;
    al=(al*(p-1)+(d<0?-d:0))/p;}
  return al===0?100:100-100/(1+ag/al);
};
const atr=(h,l,c,p)=>{if(h.length<p+1)return null;const tr=[];
  for(let i=1;i<h.length;i++)tr.push(
    Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1]))
  );
  return sma(tr.slice(-p),p);
};
async function pollA(){
  for(const intv of Object.keys(TF)){
    try{
      const rows = await fetch(
        `https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${intv}&limit=${LIMIT}`
      ).then(r=>r.json());
      const c = rows.map(r=>+r[4]), h = rows.map(r=>+r[2]), l = rows.map(r=>+r[3]), last=c.at(-1);
      byId(`${intv}-ema50`).textContent  = fmt(ema(c,50));
      byId(`${intv}-ema200`).textContent = fmt(ema(c,200));
      byId(`${intv}-rsi`).textContent    = fmt(rsi(c,14),1);
      byId(`${intv}-bb`).textContent     = fmt(std(c,20)?((4*std(c,20)/last)*100):null);
      byId(`${intv}-atr`).textContent    = fmt(atr(h,l,c,14)?((atr(h,l,c,14)/last)*100):null);
    }catch(e){console.error('A',intv,e);}
  }
}
pollA(); setInterval(pollA,CADENCE.A);

/* â”€â”€â”€ BLOCK B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function pollB(){
  const tbl = byId('tblB');
  try{
    const fr = await fetch(
      `https://fapi.binance.com/fapi/v1/fundingRate?symbol=${SYMBOL}&limit=1000`
    ).then(r=>r.json());
    const arr=fr.slice(-42).map(d=>+d.fundingRate),
          m  =arr.reduce((s,x)=>s+x,0)/arr.length,
          sd =Math.sqrt(arr.reduce((t,x)=>t+(x-m)**2,0)/arr.length),
          z  =sd?((arr.at(-1)-m)/sd).toFixed(2):'0.00';
    setCell(tbl,'Funding z-score', z);
    const [oiNow,oiHist]=await Promise.all([
      fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${SYMBOL}`).then(r=>r.json()),
      fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${SYMBOL}&period=1h&limit=24`).then(r=>r.json())
    ]);
    const pct = (((+oiNow.openInterest - +oiHist[0].sumOpenInterest)
                 /+oiHist[0].sumOpenInterest)*100).toFixed(1);
    setCell(tbl,'OI %Î” (24 h)', `${pct} %`);
  }catch(e){console.error('B',e);}
}
pollB(); setInterval(pollB,CADENCE.B);

/* â”€â”€â”€ BLOCK C (placeholder) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
 // nothing to run; static â€œ[Work in progress]â€ display

/* â”€â”€â”€ BLOCK D â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function pollCmnt(){
  const tbl = byId('tblC');
  try{
    const cg = await fetch(`https://api.coingecko.com/api/v3/coins/${CG_ID}`)
                  .then(r=>r.json());
    setCell(tbl,'Sentiment votes %', fmt(cg.sentiment_votes_up_percentage,1));
    setCell(tbl,'Community score',  fmt(cg.community_score,1));
    setCell(tbl,'Reddit posts 48 h', cg.community_data.reddit_posts_48h ?? 'âš ï¸');
  }catch(e){console.error('D',e);}
}
pollCmnt(); setInterval(pollCmnt,CADENCE.D);

/* â”€â”€â”€ BLOCK E (Coingecko global) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function pollE(){
  const tbl = byId('tblE');
  try{
    const g = await fetch('https://api.coingecko.com/api/v3/global')
                    .then(r=>r.json()).then(j=>j.data);
    setCell(tbl,'Total Market Cap (USD T)', `$${(g.total_market_cap.usd/1e12).toFixed(2)}`);
    setCell(tbl,'24 h MCap Î” %',          `${g.market_cap_change_percentage_24h_usd.toFixed(2)} %`);
    setCell(tbl,'BTC Dominance %',        `${g.market_cap_percentage.btc.toFixed(2)} %`);
    setCell(tbl,'ETH Dominance %',        `${g.market_cap_percentage.eth.toFixed(2)} %`);
  }catch(e){console.error('E',e);}
}
pollE(); setInterval(pollE,CADENCE.E);

/* â”€â”€â”€ status clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
setInterval(()=>{
  byId('status').textContent = 'Last refresh '+new Date().toLocaleTimeString();
},1000);
</script>
</body>
</html>
