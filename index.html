<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signal Blocks — BTCUSDT Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-[13px] leading-5">
  <div class="max-w-6xl mx-auto p-4 space-y-8">

    <h1 class="text-2xl font-bold">📊 Signal Blocks — BTCUSDT</h1>

    <!-- █ Block A █ -->
    <section id="blockA" class="space-y-4">
      <h2 class="text-xl font-semibold">🟦 Block A · Price · Volatility · Trend</h2>
      <div id="cardsA" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"></div>
    </section>

    <!-- █ Block B █ -->
    <section id="blockB" class="space-y-2">
      <h2 class="text-xl font-semibold">🟨 Block B · Derivatives Positioning</h2>
      <table id="tblB" class="w-full text-left bg-white rounded shadow">
        <thead class="bg-slate-100">
          <tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- █ Block C █ -->
    <section id="blockC" class="space-y-2">
      <h2 class="text-xl font-semibold">🟪 Block C · Sentiment · Community</h2>
      <table id="tblC" class="w-full text-left bg-white rounded shadow">
        <thead class="bg-slate-100">
          <tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <p id="status" class="text-gray-500"></p>
  </div>

  <script>
    /* ── CONFIG ───────────────────────────────────────── */
    const SYMBOL = 'BTCUSDT';
    const CG_ID   = 'bitcoin';
    const LIMIT   = 250;
    const TF      = { '15m': '15 m', '1h': '1 h', '4h': '4 h', '1d': '1 d' };
    const CADENCE = { A: 60_000, B: 60_000, C: 180_000 };

    /* ── HELPERS ─────────────────────────────────────── */
    const byId = id => document.getElementById(id);
    const fmt  = (x,p=2) => x==null ? '⚠️' : (+x).toFixed(p);
    function setCell(tbl,key,val){
      let row = tbl.querySelector(`tr[data-k="${key}"]`);
      if(!row){
        row = document.createElement('tr');
        row.dataset.k = key;
        row.innerHTML = `<td class="p-1">${key}</td><td class="p-1" data-v></td>`;
        tbl.querySelector('tbody').appendChild(row);
      }
      row.querySelector('[data-v]').textContent = val;
    }

    /* ── BLOCK A ─────────────────────────────────────── */
    // Build cards
    const wrapA = byId('cardsA');
    Object.entries(TF).forEach(([interval,label])=>{
      wrapA.insertAdjacentHTML('beforeend',`
        <div class="bg-white rounded shadow p-3 space-y-1">
          <h3 class="font-medium">${label}</h3>
          <div>EMA-50       <span id="${interval}-ema50">…</span></div>
          <div>EMA-200      <span id="${interval}-ema200">…</span></div>
          <div>RSI-14       <span id="${interval}-rsi">…</span></div>
          <div>BB width %   <span id="${interval}-bb">…</span></div>
          <div>ATR/Close %  <span id="${interval}-atr">…</span></div>
        </div>`);
    });

    // Math helpers
    const sma = (a,p) => a.slice(-p).reduce((s,x)=>s+x,0)/p;
    const std = (a,p) => { const s=a.slice(-p),m=sma(s,p); return Math.sqrt(s.reduce((t,x)=>t+(x-m)**2,0)/p); };
    const ema = (a,p) => { if(a.length<p) return null; const k=2/(p+1); let e=sma(a.slice(0,p),p);
      for(let i=p;i<a.length;i++) e = a[i]*k + e*(1-k); return e; };
    const rsi = (a,p) => { if(a.length<p+1) return null; let g=0,l=0;
      for(let i=1;i<=p;i++){ const d=a[i]-a[i-1]; d>=0?g+=d:l-=d; }
      let ag=g/p,al=l/p;
      for(let i=p+1;i<a.length;i++){ const d=a[i]-a[i-1];
        ag=(ag*(p-1)+(d>0?d:0))/p; al=(al*(p-1)+(d<0?-d:0))/p; }
      return al===0?100:100-100/(1+ag/al);
    };
    const atr = (h,l,c,p) => { if(h.length<p+1) return null; const tr=[]; 
      for(let i=1;i<h.length;i++) tr.push(
        Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1]))
      );
      return sma(tr.slice(-p),p);
    };

    // Fetch and render A
    async function pollA(){
      for(const [interval] of Object.entries(TF)){
        try{
          const rows = await fetch(
            `https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${interval}&limit=${LIMIT}`
          ).then(r=>r.json());
          const close = rows.map(r=>+r[4]),
                high  = rows.map(r=>+r[2]),
                low   = rows.map(r=>+r[3]),
                last  = close.at(-1);

          const ema50   = ema(close,50),
                ema200  = ema(close,200),
                rsi14   = rsi(close,14),
                bbw     = std(close,20) ? ((4*std(close,20)/last)*100).toFixed(2) : null,
                atrp    = atr(high,low,close,14) ? ((atr(high,low,close,14)/last)*100).toFixed(2) : null;

          byId(`${interval}-ema50`).textContent  = fmt(ema50);
          byId(`${interval}-ema200`).textContent = fmt(ema200);
          byId(`${interval}-rsi`).textContent    = fmt(rsi14,1);
          byId(`${interval}-bb`).textContent     = fmt(bbw);
          byId(`${interval}-atr`).textContent    = fmt(atrp);
        } catch(e){ console.error('A',interval,e); }
      }
    }
    pollA();
    setInterval(pollA, CADENCE.A);

    /* ── BLOCK B ───────────────────────────────────── */
    async function pollB(){
      const tbl = document.querySelector('#tblB tbody');
      try{
        const fr = await fetch(
          `https://fapi.binance.com/fapi/v1/fundingRate?symbol=${SYMBOL}&limit=1000`
        ).then(r=>r.json());
        const z = (()=>{
          const arr = fr.slice(-42).map(d=>+d.fundingRate);
          const m = arr.reduce((s,x)=>s+x,0)/arr.length;
          const sd= Math.sqrt(arr.reduce((s,x)=>s+(x-m)**2,0)/arr.length);
          return sd?((arr.at(-1)-m)/sd).toFixed(2):0;
        })();

        setCell(tbl,'Funding z-score', z);
        const [oiNow, oiHist] = await Promise.all([
          fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${SYMBOL}`).then(r=>r.json()),
          fetch(`https://fapi.binance.com/futures/data/openInterestHist?symbol=${SYMBOL}&period=1h&limit=24`).then(r=>r.json())
        ]);
        const pct = (((+oiNow.openInterest - +oiHist[0].sumOpenInterest)
                     / +oiHist[0].sumOpenInterest)*100).toFixed(1);
        setCell(tbl,'OI %Δ (24h)', `${pct} %`);
      } catch(e){ console.error('B',e); }
    }
    pollB();
    setInterval(pollB, CADENCE.B);

    /* ── BLOCK C ───────────────────────────────────── */
    async function pollC(){
      const tbl = document.querySelector('#tblC tbody');
      try{
        const d = await fetch(
          `https://api.coingecko.com/api/v3/coins/${CG_ID}`
        ).then(r=>r.json());
        setCell(tbl,'Sentiment votes %', fmt(d.sentiment_votes_up_percentage,1));
        setCell(tbl,'Community score',   fmt(d.community_score,1));
        setCell(tbl,'Reddit posts 48h',  d.community_data?.reddit_posts_48h ?? '⚠️');
      } catch(e){ console.error('C',e); }
    }
    pollC();
    setInterval(pollC, CADENCE.C);

    /* ── status clock ───────────────────────────────── */
    setInterval(()=>{
      byId('status').textContent = 'Last refresh ' + new Date().toLocaleTimeString();
    }, 1000);
  </script>
</body>
</html>
